<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FloodSim</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css"
    />
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/bundle.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }

      .info-panel {
        font-family: "Segoe UI", Arial, sans-serif;
        min-width: 320px;
      }
      .sim-btn {
        background: #d9534f;
        color: white;
        border: none;
        padding: 10px 15px;
        width: 100%;
        cursor: pointer;
        margin-top: 10px;
        font-weight: bold;
        border-radius: 4px;
        transition: 0.3s;
      }
      .sim-btn:hover {
        background: #c9302c;
      }

      .loading-text {
        color: #666;
        font-style: italic;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      select {
        width: 100%;
        padding: 5px;
        margin-top: 5px;
        border: 1px solid #0044ff;
        border-radius: 4px;
        font-weight: bold;
      }

      /* CSS cho c·∫£nh b√°o l·ªãch s·ª≠ */
      .history-alert {
        margin-top: 5px;
        padding: 8px;
        border-left: 4px solid;
        font-size: 12px;
        border-radius: 4px;
      }
      .alert-danger {
        background: #fff2f0;
        border-color: red;
      }
      .alert-safe {
        background: #f6ffed;
        border-color: green;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      // ƒê·ªãnh nghƒ©a ph·∫°m vi Vi·ªát Nam
      var vietnamBounds = L.latLngBounds(
        [8.0, 102.0], // T√¢y Nam
        [23.5, 110.0] // ƒê√¥ng B·∫Øc
      );

      // T·∫°o b·∫£n ƒë·ªì v·ªõi ph·∫°m vi gi·ªõi h·∫°n
      var map = L.map("map", {
        center: [16.0, 106.0],
        zoom: 6,
        maxBounds: vietnamBounds,
        maxZoom: 18,
        minZoom: 6,
      });

      // S·ª≠ d·ª•ng OpenStreetMap l√†m n·ªÅn b·∫£n ƒë·ªì
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18,
        noWrap: true, // NgƒÉn kh√¥ng load c√°c tile ngo√†i Vi·ªát Nam
        bounds: vietnamBounds,
      }).addTo(map);

      // Th√™m layer t√™n ƒë·ªãa ph∆∞∆°ng
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "",
        maxZoom: 18,
        noWrap: true,
        bounds: vietnamBounds,
      }).addTo(map);

      // 1. DATA: DANH S√ÅCH 40 ƒê·∫¨P (R√∫t g·ªçn demo v√†i c√°i ch√≠nh)
      var danhSachDap = [
        {
          id: 1,
          ten: "Th·ªßy ƒëi·ªán Lai Ch√¢u",
          vido: 22.385,
          kinhdo: 102.793,
          loai: "L·ªõn",
          thuongNguon: "Bi√™n gi·ªõi TQ",
        },
        {
          id: 2,
          ten: "Th·ªßy ƒëi·ªán S∆°n La",
          vido: 21.4939,
          kinhdo: 103.9822,
          loai: "L·ªõn",
          thuongNguon: "Tƒê Lai Ch√¢u",
        },
        {
          id: 3,
          ten: "Th·ªßy ƒëi·ªán H√≤a B√¨nh",
          vido: 20.8146,
          kinhdo: 105.3373,
          loai: "L·ªõn",
          thuongNguon: "Tƒê S∆°n La",
        },
        {
          id: 4,
          ten: "Th·ªßy ƒëi·ªán Th√°c B√†",
          vido: 21.7569,
          kinhdo: 105.0569,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng Ch·∫£y",
        },
        {
          id: 5,
          ten: "Th·ªßy ƒëi·ªán Tuy√™n Quang",
          vido: 22.1833,
          kinhdo: 105.25,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng G√¢m",
        },
        {
          id: 6,
          ten: "Th·ªßy ƒëi·ªán B·∫£n V·∫Ω",
          vido: 19.05,
          kinhdo: 104.65,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng C·∫£",
        },
        {
          id: 7,
          ten: "Th·ªßy ƒëi·ªán S√¥ng Tranh 2",
          vido: 15.3833,
          kinhdo: 108.1833,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Tranh",
        },
        {
          id: 8,
          ten: "Th·ªßy ƒëi·ªán A V∆∞∆°ng",
          vido: 15.7667,
          kinhdo: 107.8,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng A V∆∞∆°ng",
        },
        {
          id: 9,
          ten: "Th·ªßy ƒëi·ªán ƒê·ªìng Nai 3",
          vido: 11.9667,
          kinhdo: 108.2833,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·ªìng Nai",
        },
        {
          id: 10,
          ten: "Th·ªßy ƒëi·ªán ƒê·ªìng Nai 4",
          vido: 11.8167,
          kinhdo: 108.1667,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·ªìng Nai",
        },
        {
          id: 11,
          ten: "H·ªì Th√°c B√†",
          vido: 21.7569,
          kinhdo: 105.0569,
          loai: "H·ªì",
          thuongNguon: "S√¥ng Ch·∫£y",
        },
        {
          id: 12,
          ten: "H·ªì S√¥ng C·∫ßu",
          vido: 21.2833,
          kinhdo: 105.85,
          loai: "H·ªì",
          thuongNguon: "S√¥ng C·∫ßu",
        },
        {
          id: 13,
          ten: "H·ªì K·∫ª G·ªó (H√† Tƒ©nh)",
          vido: 18.2333,
          kinhdo: 105.95,
          loai: "H·ªì",
          thuongNguon: "S√¥ng R√†o C√°i",
        },
        {
          id: 14,
          ten: "Th·ªßy ƒëi·ªán B√¨nh ƒêi·ªÅn",
          vido: 16.3667,
          kinhdo: 107.7333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng B·ªì",
        },
        {
          id: 15,
          ten: "Th·ªßy ƒëi·ªán H∆∞∆°ng ƒêi·ªÅn",
          vido: 16.483,
          kinhdo: 107.452,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng B·ªì",
        },
        {
          id: 16,
          ten: "Th·ªßy ƒëi·ªán R√†o Qu√°n",
          vido: 16.8167,
          kinhdo: 106.9667,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng R√†o Qu√°n",
        },
        {
          id: 17,
          ten: "Th·ªßy ƒëi·ªán S√™r√™p·ªëk 3",
          vido: 12.6667,
          kinhdo: 107.8333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng S√™r√™p·ªëk",
        },
        {
          id: 18,
          ten: "Th·ªßy ƒëi·ªán S√™r√™p·ªëk 4",
          vido: 12.5667,
          kinhdo: 107.7667,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng S√™r√™p·ªëk",
        },
        {
          id: 19,
          ten: "Th·ªßy ƒëi·ªán ƒê·∫Øk Mi 4",
          vido: 15.4667,
          kinhdo: 107.8333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·∫Øk Mi",
        },
        {
          id: 20,
          ten: "Th·ªßy ƒëi·ªán ƒê·∫Øk Mi 3",
          vido: 15.5167,
          kinhdo: 107.9,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·∫Øk Mi",
        },
        {
          id: 21,
          ten: "Th·ªßy ƒëi·ªán Kr√¥ng H'NƒÉng",
          vido: 12.5,
          kinhdo: 108.3333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Kr√¥ng H'NƒÉng",
        },
        {
          id: 22,
          ten: "Th·ªßy ƒëi·ªán ƒê·∫Øk Kar",
          vido: 12.1667,
          kinhdo: 108.5,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·∫Øk Kar",
        },
        {
          id: 23,
          ten: "Th·ªßy ƒëi·ªán ƒê·∫°i Ninh",
          vido: 11.5833,
          kinhdo: 108.3333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒêa Nhim",
        },
        {
          id: 24,
          ten: "Th·ªßy ƒëi·ªán H√†m Thu·∫≠n - ƒêa Mi",
          vido: 11.25,
          kinhdo: 108.0833,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng La Ng√†",
        },
        {
          id: 25,
          ten: "Th·ªßy ƒëi·ªán C·∫ßn ƒê∆°n",
          vido: 11.8333,
          kinhdo: 106.8333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng B√©",
        },
        {
          id: 26,
          ten: "Th·ªßy ƒëi·ªán Th√°c M∆°",
          vido: 11.8333,
          kinhdo: 107.0,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng B√©",
        },
        {
          id: 27,
          ten: "Th·ªßy ƒëi·ªán Srok Phu Mi√™ng",
          vido: 12.3333,
          kinhdo: 107.1667,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Srok Phu Mi√™ng",
        },
        {
          id: 28,
          ten: "Th·ªßy ƒëi·ªán ƒê·ª©c Xuy√™n",
          vido: 11.9167,
          kinhdo: 107.5,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·ªìng Nai",
        },
        {
          id: 29,
          ten: "Th·ªßy ƒëi·ªán ƒê·ªìng Nai 2",
          vido: 11.75,
          kinhdo: 108.0833,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·ªìng Nai",
        },
        {
          id: 30,
          ten: "Th·ªßy ƒëi·ªán ƒê·∫Øk R'T√≠h",
          vido: 12.0833,
          kinhdo: 108.1667,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng ƒê·∫Øk R'T√≠h",
        },
        {
          id: 31,
          ten: "Th·ªßy ƒëi·ªán Tr·ªã An",
          vido: 11.127,
          kinhdo: 107.085,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng ƒê·ªìng Nai",
        },
        {
          id: 32,
          ten: "Th·ªßy ƒëi·ªán Vƒ©nh S∆°n",
          vido: 14.0833,
          kinhdo: 108.75,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Ba",
        },
        {
          id: 33,
          ten: "Th·ªßy ƒëi·ªán S√¥ng Ba H·∫°",
          vido: 13.4167,
          kinhdo: 108.8333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Ba",
        },
        {
          id: 34,
          ten: "Th·ªßy ƒëi·ªán Ayun H·∫°",
          vido: 13.5833,
          kinhdo: 108.5,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Ayun",
        },
        {
          id: 35,
          ten: "Th·ªßy ƒëi·ªán Ialy",
          vido: 14.1667,
          kinhdo: 107.8333,
          loai: "L·ªõn",
          thuongNguon: "S√¥ng S√™ San",
        },
        {
          id: 36,
          ten: "Th·ªßy ƒëi·ªán S√™ San 3",
          vido: 14.3333,
          kinhdo: 107.8333,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng S√™ San",
        },
        {
          id: 37,
          ten: "Th·ªßy ƒëi·ªán S√™ San 3A",
          vido: 14.25,
          kinhdo: 107.75,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng S√™ San",
        },
        {
          id: 38,
          ten: "Th·ªßy ƒëi·ªán Plei Kr√¥ng",
          vido: 14.5833,
          kinhdo: 107.9167,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng S√™ San",
        },
        {
          id: 39,
          ten: "Th·ªßy ƒëi·ªán S√¥ng Hinh",
          vido: 12.8333,
          kinhdo: 108.9167,
          loai: "V·ª´a",
          thuongNguon: "S√¥ng Ba",
        },
        {
          id: 40,
          ten: "H·ªì D·∫ßu Ti·∫øng",
          vido: 11.3619,
          kinhdo: 106.3458,
          loai: "H·ªì",
          thuongNguon: "S√¥ng S√†i G√≤n",
        },
      ];

      // 2. DATA: DANH S√ÅCH ƒêEN (V√πng hay ng·∫≠p)
      var vungNguyHiem = [
        "Th·ª´a Thi√™n Hu·∫ø",
        "Qu·∫£ng Tr·ªã",
        "Qu·∫£ng B√¨nh",
        "H√† Tƒ©nh",
        "Ngh·ªá An",
        "Qu·∫£ng Nam",
        "Ph√∫ Y√™n",
        "Kh√°nh Ho√†",
        "B√¨nh ƒê·ªãnh",
      ];

      // V·∫Ω Marker l√™n b·∫£n ƒë·ªì
      danhSachDap.forEach((dap) => {
        var color =
          dap.loai === "L·ªõn" ? "red" : dap.loai === "V·ª´a" ? "orange" : "blue";
        var size = dap.loai === "L·ªõn" ? 16 : 12;
        var icon = L.divIcon({
          className: "custom-div-icon",
          html: `<div style='background:${color}; width:${size}px; height:${size}px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px ${color};'></div>`,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });
        L.marker([dap.vido, dap.kinhdo], { icon: icon })
          .addTo(map)
          .bindTooltip(dap.ten);
        // Gi·∫£m b√°n k√≠nh v√≤ng tr√≤n ƒë·ªÉ tr√°nh ch·ªìng ch√©o
        L.circle([dap.vido, dap.kinhdo], {
          color: "blue",
          fillOpacity: 0.05,
          radius: 1000,
        }).addTo(map);
      });

      var currentResults = null;
      var selectedPoint = null;
      window.currentTop3 = [];

      // 3. API: L·∫§Y ƒê·ªò CAO (Open-Meteo)
      async function getDoCao(lat, lng) {
        try {
          const res = await fetch(
            `https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`
          );
          const data = await res.json();
          return data.elevation[0];
        } catch (e) {
          return 5;
        } // M·∫•t m·∫°ng tr·∫£ v·ªÅ 5m
      }

      // 4. API: L·∫§Y T√äN T·ªàNH (BigDataCloud) - ƒê·ªÉ check l·ªãch s·ª≠
      async function getTenTinh(lat, lng) {
        try {
          const res = await fetch(
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=vi`
          );
          const data = await res.json();
          return data.principalSubdivision || "Kh√¥ng x√°c ƒë·ªãnh";
        } catch (e) {
          return "Kh√¥ng x√°c ƒë·ªãnh";
        }
      }

      // 5. LOGIC: T√çNH TO√ÅN
      function tinhToan(dist, doCao) {
        var heSo = 1 + doCao / 3;
        return Math.round((500 + dist * 0.2) * heSo);
      }

      // 6. S·ª∞ KI·ªÜN CLICK (T√≠ch h·ª£p t·∫•t c·∫£)
      map.on("click", async function (e) {
        selectedPoint = e.latlng;
        L.popup()
          .setLatLng(e.latlng)
          .setContent(
            "<div class='loading-text'>‚è≥ ƒêang ph√¢n t√≠ch d·ªØ li·ªáu ƒëa ngu·ªìn...</div>"
          )
          .openOn(map);
        if (currentResults) {
          map.removeLayer(currentResults.marker);
          map.removeLayer(currentResults.circle);
        }

        // A. T√¨m 3 ƒë·∫≠p g·∫ßn nh·∫•t
        var daps = danhSachDap.map((d) => {
          return {
            ...d,
            dist: L.latLng(d.vido, d.kinhdo).distanceTo(e.latlng),
          };
        });
        daps.sort((a, b) => a.dist - b.dist);
        window.currentTop3 = daps.slice(0, 3);
        var dapGanNhat = window.currentTop3[0];

        // B. G·ªçi 2 API c√πng l√∫c (ƒê·ªô cao + T√™n t·ªânh)
        var doCao = await getDoCao(e.latlng.lat, e.latlng.lng);
        var tenTinh = await getTenTinh(e.latlng.lat, e.latlng.lng);

        // C. Check L·ªãch s·ª≠ ng·∫≠p
        var htmlCanhBao = "";
        if (vungNguyHiem.some((v) => tenTinh.includes(v))) {
          htmlCanhBao = `<div class="history-alert alert-danger">‚ö†Ô∏è <b>C·∫¢NH B√ÅO L·ªäCH S·ª¨:</b><br>${tenTinh} l√† v√πng th∆∞·ªùng xuy√™n ng·∫≠p l·ª•t.</div>`;
        } else {
          htmlCanhBao = `<div class="history-alert alert-safe">‚úÖ <b>L·ªäCH S·ª¨ AN TO√ÄN:</b><br>${tenTinh} √≠t ghi nh·∫≠n ng·∫≠p nghi√™m tr·ªçng.</div>`;
        }

        // D. Hi·ªÉn th·ªã Popup
        var nguong = tinhToan(dapGanNhat.dist, doCao);
        var options = window.currentTop3
          .map(
            (d) =>
              `<option value="${d.id}">${d.ten} (${(d.dist / 1000).toFixed(
                1
              )} km)</option>`
          )
          .join("");

        var popupHTML = `
                <div class="info-panel">
                    <h3 style="margin:0; color:#0044ff; border-bottom:2px solid #ddd;">Ph√¢n T√≠ch ƒêa Ngu·ªìn</h3>
                    ${htmlCanhBao} <div style="margin-top:10px;">
                        <label style="font-size:12px; font-weight:bold;">Ngu·ªìn x·∫£ l≈© gi·∫£ l·∫≠p:</label>
                        <select id="selectDap" onchange="doiDap(this.value, ${doCao})">${options}</select>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px; font-size:13px">
                        <div style="background:#f5f5f5; padding:5px;">‚õ∞Ô∏è ƒê·ªô cao: <b>${doCao}m</b></div>
                        <div style="background:#eeffee; padding:5px;">üõ°Ô∏è Ng∆∞·ª°ng: <b id="lblNguong" style="color:green">${nguong.toLocaleString()}</b></div>
                    </div>

                    <div style="background:#fff0f0; padding:10px; margin-top:10px; border:1px solid #ffccc7;">
                        <label><b>X·∫£ l≈© (m¬≥/s):</b></label>
                        <input type="number" id="inpXa" value="${
                          nguong + 500
                        }" style="width:100%; padding:5px; margin-top:5px;">
                        <button class="sim-btn" onclick="chaySim(${doCao})">CH·∫†Y M√î PH·ªéNG</button>
                    </div>
                </div>
            `;
        L.popup().setLatLng(e.latlng).setContent(popupHTML).openOn(map);
      });

      // H·ªó tr·ª£ ƒë·ªïi ƒë·∫≠p
      window.doiDap = function (id, doCao) {
        var dap = window.currentTop3.find((d) => d.id == id);
        var nguong = tinhToan(dap.dist, doCao);
        document.getElementById("lblNguong").innerText =
          nguong.toLocaleString();
        document.getElementById("inpXa").value = nguong + 500;
      };

      // Ch·∫°y m√¥ ph·ªèng
      window.chaySim = function (doCao) {
        var id = document.getElementById("selectDap").value;
        var val = parseFloat(document.getElementById("inpXa").value);
        var dap = window.currentTop3.find((d) => d.id == id);
        var nguong = tinhToan(dap.dist, doCao);

        map.closePopup();

        var color = val > nguong ? "red" : "green";
        var text = val > nguong ? "C·∫¢NH B√ÅO NG·∫¨P" : "AN TO√ÄN";
        var radius = val > nguong ? (val - nguong) * 2 : 300;
        if (radius > 50000) radius = 50000;
        if (radius < 300) radius = 300;

        // Hi·ªán b√°n k√≠nh
        var txtRadius =
          radius >= 1000
            ? (radius / 1000).toFixed(1) + " km"
            : radius.toFixed(0) + " m";

        var marker = L.marker([selectedPoint.lat, selectedPoint.lng])
          .addTo(map)
          .bindPopup(
            `<b style="color:${color}">${text}</b><br>Ngu·ªìn: ${dap.ten}<br>Ph·∫°m vi: ${txtRadius}`
          )
          .openPopup();

        var circle = L.circle([selectedPoint.lat, selectedPoint.lng], {
          color: color,
          fillColor: color,
          fillOpacity: 0.5,
          radius: radius,
        }).addTo(map);

        currentResults = { marker: marker, circle: circle };
        map.flyTo(selectedPoint, 11);
      };

      // Gi·ªõi h·∫°n b·∫£n ƒë·ªì ch·ªâ hi·ªÉn th·ªã Vi·ªát Nam
      map.setMaxBounds(vietnamBounds);

      //Th√™m thanh t√¨m ki·∫øm
      const searchControl = new GeoSearch.GeoSearchControl({
        provider: new GeoSearch.OpenStreetMapProvider(),
        style: "bar",
        searchLabel: "T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm t·∫°i Vi·ªát Nam...",
        autoClose: true,
      });
      map.addControl(searchControl);
    </script>
  </body>
</html>
