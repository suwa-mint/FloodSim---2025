<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FloodSim </title>

  <!-- Th∆∞ vi·ªán b√™n ngo√†i -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- File CSS  -->
  <link rel="stylesheet" href="css/style.css">

  <script>
    // ========== C·∫§U H√åNH H·ªÜ TH·ªêNG ==========
    const CONFIG = {
      vietnamBounds: [[6, 80], [25, 200]],
      mapCenter: [16.0, 106.0],
      zoom: 6,
    };
  </script>
</head>

<body>
  <!-- ========== PH·∫¶N T√åM KI·∫æM ========== -->
  <div class="search-container">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput"
        placeholder="Nh·∫≠p t·ªânh th√†nh, th√†nh ph·ªë ho·∫∑c ƒë·ªãa ƒëi·ªÉm t·∫°i Vi·ªát Nam..." autocomplete="off">
      <button class="search-button" onclick="performSearch()">
        <i class="fas fa-search"></i>T√¨m ki·∫øm
      </button>
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- ========== N√öT M·ªû B·∫¢NG CH√ö TH√çCH ========== -->
  <button class="legend-toggle" id="legendToggle">
    <i class="fas fa-layer-group"></i>Hi·ªán ch√∫ th√≠ch
  </button>

  <!-- ========== B·∫¢N ƒê·ªí CH√çNH ========== -->
  <div id="map"></div>

  <!-- ========== B·∫¢NG CH√ö TH√çCH (B√äN PH·∫¢I) ========== -->
  <div class="legend-panel" id="legendPanel">
    <div class="panel-header">
      <div class="panel-title"><i class="fas fa-water"></i>FLOODSIM</div>
      <div class="panel-subtitle">H·ªá th·ªëng c·∫£nh b√°o ng·∫≠p l·ª•t th√¥ng minh</div>
    </div>

    <!-- Ph·∫ßn ch√∫ th√≠ch b·∫£n ƒë·ªì -->
    <div class="legend-section">
      <div class="section-title"><i class="fas fa-map-marker-alt"></i>CH√ö TH√çCH B·∫¢N ƒê·ªí</div>
      <div class="legend-item" style="border-left-color: #33ebff;" onclick="toggleDamLayer('large', this)">
        <div class="legend-color" style="background: #33ebff; border-color: #fff;"></div>
        <div class="legend-text">Th·ªßy ƒëi·ªán l·ªõn (>100MW)</div>
      </div>
      <div class="legend-item" style="border-left-color: #ff9900;" onclick="toggleDamLayer('medium', this)">
        <div class="legend-color" style="background: #ff9900; border-color: #fff;"></div>
        <div class="legend-text">Th·ªßy ƒëi·ªán v·ª´a (30-100MW)</div>
      </div>
      <div class="legend-item" style="border-left-color: #0066ff;" onclick="toggleDamLayer('reservoir', this)">
        <div class="legend-color" style="background: #0066ff; border-color: #fff;"></div>
        <div class="legend-text">H·ªì ch·ª©a n∆∞·ªõc v√† ƒë·∫≠p</div>
      </div>
      <div class="legend-item" style="border-left-color: #33cc33">
        <div class="legend-color" style="background: #33cc33"></div>
        <div class="legend-text">V√πng an to√†n (√≠t ng·∫≠p)</div>
      </div>
      <div class="legend-item" style="border-left-color: #ff0000;" onclick="toggleDangerLayer(this)">
        <div class="legend-color" style="background: rgba(255, 0, 0, 0.5); border: 2px solid #ff0000;"></div>
        <div class="legend-text">V√πng nguy hi·ªÉm (th∆∞·ªùng xuy√™n ng·∫≠p)</div>
      </div>
      <div class="legend-item" style="border-left-color: #800080">
        <div class="legend-color" style="background: rgba(128,0,128,0.3); border: 2px solid #800080;"></div>
        <div class="legend-text">Khu v·ª±c ·∫£nh h∆∞·ªüng x·∫£ l≈©</div>
      </div>
    </div>

    <!-- Ph·∫ßn th·ªëng k√™ -->
    <div class="legend-section">
      <div class="section-title"><i class="fas fa-chart-bar"></i>TH·ªêNG K√ä H·ªÜ TH·ªêNG</div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="totalDams">40</div>
          <div class="stat-label">C√¥ng tr√¨nh th·ªßy ƒëi·ªán</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dangerAreas">9</div>
          <div class="stat-label">T·ªânh nguy hi·ªÉm</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="largeDams">12</div>
          <div class="stat-label">Th·ªßy ƒëi·ªán l·ªõn</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="mediumDams">25</div>
          <div class="stat-label">Th·ªßy ƒëi·ªán v·ª´a</div>
        </div>
      </div>
    </div>

    <!-- Ph·∫ßn h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
    <div class="legend-section">
      <div class="section-title"><i class="fas fa-info-circle"></i>H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</div>
      <div class="instruction-content">
        <p><strong>1.</strong> Nh·∫•n v√†o ch√∫ th√≠ch b·∫£n ƒë·ªì ƒë·ªÉ xem v·ªã tr√≠</p>
        <p><strong>2.</strong> Nh·∫•n v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠ ph√¢n t√≠ch</p>
        <p><strong>3.</strong> H·ªá th·ªëng t·ª± ƒë·ªông t√¨m 3 ƒë·∫≠p g·∫ßn nh·∫•t</p>
        <p><strong>4.</strong> Ch·ªçn ƒë·∫≠p ƒë·ªÉ m√¥ ph·ªèng x·∫£ l≈©</p>
        <p><strong>5.</strong> Nh·∫≠p l∆∞u l∆∞·ª£ng x·∫£ v√† ch·∫°y m√¥ ph·ªèng</p>
        <p><strong>6.</strong> Xem k·∫øt qu·∫£ c·∫£nh b√°o tr√™n b·∫£n ƒë·ªì</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="panel-footer">
      <div class="footer-note">D·ªØ li·ªáu c·∫≠p nh·∫≠t ƒë·∫øn th√°ng 12/2025</div>
      <div class="footer-copy"> 2025 FloodSim</div>
    </div>
  </div>

  <!-- ========== PANEL XEM ·∫¢NH CHI TI·∫æT ========== -->
  <div class="dam-detail-panel" id="damDetailPanel">
    <button class="close-detail" onclick="closeDamDetail()">&times;</button>
    <img src="" alt="" class="dam-detail-image" id="damDetailImage" onclick="openImageModal(this.src)"
      title="Nh·∫•n ƒë·ªÉ ph√≥ng to">
    <div class="dam-detail-title" id="damDetailTitle"></div>
    <div class="dam-detail-info" id="damDetailInfo"></div>
  </div>

  <!-- ========== MODAL PH√ìNG TO ·∫¢NH ========== -->
  <div id="imageModal" class="image-modal" onclick="this.style.display='none'">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
  </div>

  <!-- ========== T·∫¢I FILE D·ªÆ LI·ªÜU ========== -->
  <script src="js/data.js"></script>
  <script src="js/logic.js"></script>
  <script src="js/main.js"></script>

  <script>
    // ========== BI·∫æN TO√ÄN C·ª§C ==========
    let map;
    let legendVisible = false;
    let damLayers = {
      large: L.layerGroup(),
      medium: L.layerGroup(),
      reservoir: L.layerGroup()
    };
    let damStates = { large: false, medium: false, reservoir: false };
    let dangerLayer = L.layerGroup();
    let isDangerLayerVisible = false;
    let currentMarker = null;
    let latestClickTime = 0;

    // T·ªça ƒë·ªô c√°c v√πng nguy hi·ªÉm (D√πng chung cho click v√† layer)
    const dangerCoords = {
      "Th·ª´a Thi√™n Hu·∫ø": [16.4637, 107.5909],
      "Qu·∫£ng Tr·ªã": [16.8500, 107.1000],
      "Qu·∫£ng B√¨nh": [17.4833, 106.6000],
      "H√† Tƒ©nh": [18.3333, 105.9000],
      "Ngh·ªá An": [19.2500, 104.8000],
      "Qu·∫£ng Nam": [15.5667, 107.9667],
      "Ph√∫ Y√™n": [13.0833, 109.0833],
      "Kh√°nh Ho√†": [12.2500, 109.1833],
      "B√¨nh ƒê·ªãnh": [13.7833, 109.2167]
    };

    // ========== KH·ªûI T·∫†O B·∫¢N ƒê·ªí ==========
    function initializeMap() {
      map = L.map("map", {
        center: CONFIG.mapCenter,
        zoom: CONFIG.zoom,
        maxBounds: L.latLngBounds(CONFIG.vietnamBounds),
        maxZoom: 20,
        minZoom: 6,
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap | FloodSim',
        maxZoom: 20,
        noWrap: true,
        bounds: CONFIG.vietnamBounds,
      }).addTo(map);

      // S·ª± ki·ªán click b·∫£n ƒë·ªì ƒë·ªÉ m√¥ ph·ªèng
      map.on('click', async function (e) {
        // X√≥a marker c≈© n·∫øu c√≥
        if (currentMarker) {
          map.removeLayer(currentMarker);
          currentMarker = null;
          return;
        }

        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // ========== G·ªåI API T·ª™ MAIN.JS ==========
        const doCao = await getDoCao(lat, lng);
        const luuLuongMua = await getLuuLuongMua(lat, lng);
        const nguong = getNguongAnToan(doCao, luuLuongMua);


        // X·ª≠ l√Ω x√°c ƒë·ªãnh v√πng nguy hi·ªÉm d·ª±a tr√™n kho·∫£ng c√°ch
        let detectedLocation = "V√πng l√¢n c·∫≠n";
        let isDangerous = false;
        const detectionRadius = 50000; // 50km

        for (const area of LIST_DANGER_AREAS) {
          if (dangerCoords[area]) {
            if (map.distance([lat, lng], dangerCoords[area]) <= detectionRadius) {
              detectedLocation = area;
              isDangerous = true;
              break;
            }
          }
        }

        let htmlCanhBao = `<div class="popup-location">V·ªã tr√≠: <b>${detectedLocation}</b></div>`;
        if (isDangerous) {
          htmlCanhBao += `<div class="popup-danger">‚ö†Ô∏è Khu v·ª±c nguy hi·ªÉm cao</div>`;
        } else {
          htmlCanhBao += `<div class="popup-safe">‚úÖ Khu v·ª±c t∆∞∆°ng ƒë·ªëi an to√†n</div>`;
        }

        // T√¨m 3 ƒë·∫≠p g·∫ßn nh·∫•t (S·ª≠ d·ª•ng h√†m c√≥ s·∫µn trong logic.js)
        const nearestDams = threeNearest(lat, lng);

        // T·∫°o options cho select
        let options = nearestDams.map((d, index) =>
          `<option value="${d.id}" ${index === 0 ? 'selected' : ''}>${d.ten} (${d.distance.toFixed(1)}km)</option>`
        ).join('');

        var popupHTML = `
            <div class="info-panel">
                <h3 class="popup-header">Ph√¢n T√≠ch ƒêa Ngu·ªìn</h3>
                ${htmlCanhBao} <div class="popup-section">
                    <label class="popup-label">Ngu·ªìn x·∫£ l≈© gi·∫£ l·∫≠p:</label>
                    <select id="selectDap" onchange="doiDap(this.value, ${doCao}, ${luuLuongMua})">${options}</select>
                </div>
                <div class="popup-grid">
                    <div class="popup-grid-item height">‚õ∞Ô∏è ƒê·ªô cao: <b>${doCao}m</b></div>
                    <div class="popup-grid-item rain">üåßÔ∏è M∆∞a: <b>${luuLuongMua.toFixed(1)}mm</b></div>
                    <div class="popup-grid-item threshold">üõ°Ô∏è Ng∆∞·ª°ng an to√†n: <b id="lblNguong" class="text-green">${nguong.toLocaleString()}</b></div>
                </div>
                <div class="popup-sim-box">
                    <label><b>X·∫£ l≈© (m¬≥/s):</b></label>
                    <input type="number" id="inpXa" value="${nguong + 500}" class="popup-input">
                    <button class="sim-btn" onclick="chaySim(${doCao})">CH·∫†Y M√î PH·ªéNG</button>
                </div>
            </div>
        `;

        // Hi·ªÉn th·ªã marker t·∫°i ƒëi·ªÉm click v√† m·ªü popup
        currentMarker = L.marker([lat, lng]).addTo(map).bindPopup(popupHTML).openPopup();
      });
    }
    // ========== KH·ªûI T·∫†O C√ÅC ƒê·∫¨P ==========
    function initializeDams() {
      listdap.forEach(dap => {
        let color = '#0066ff', targetLayer = damLayers.reservoir;
        let loai = 'H·ªì';

        if (dap.dung_tich >= 1000) {
          loai = 'L·ªõn';
          color = '#33ebff';
          targetLayer = damLayers.large;
        } else if (dap.dung_tich >= 100) {
          loai = 'V·ª´a';
          color = '#ff9900';
          targetLayer = damLayers.medium;
        }

        L.circleMarker([dap.lat, dap.lng], {
          radius: 8,
          fillColor: color,
          color: "#fff",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.9
        })
          .bindPopup(`
  <img src="${dap.anh}" class="dam-popup-image" onclick="openDamDetail('${dap.id}')" title="Nh·∫•n ƒë·ªÉ xem chi ti·∫øt" onerror="this.style.display='none'">
  <div class="dam-info">
    <strong>${dap.ten}</strong>
    <div class="dam-info-row">
      <span class="dam-info-label">Lo·∫°i:</span>
      <span class="dam-info-value">${loai}</span>
    </div>
    <div class="dam-info-row">
      <span class="dam-info-label">S√¥ng:</span>
      <span class="dam-info-value">${dap.song}</span>
    </div>
    <div class="dam-info-row">
      <span class="dam-info-label">Dung t√≠ch:</span>
      <span class="dam-info-value">${dap.dung_tich} tri·ªáu m¬≥</span>
    </div>
  </div>
  `)
          .addTo(targetLayer);
      });
    }

    // ========== ƒêI·ªÄU KHI·ªÇN GIAO DI·ªÜN ==========
    function toggleLegendPanel() {
      const panel = document.getElementById("legendPanel");
      const toggleBtn = document.getElementById("legendToggle");

      panel.classList.toggle("active");
      legendVisible = panel.classList.contains("active");

      if (legendVisible) {
        toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
        toggleBtn.style.padding = "12px";
      } else {
        toggleBtn.innerHTML = '<i class="fas fa-layer-group"></i> Hi·ªán ch√∫ th√≠ch';
        toggleBtn.style.padding = "";
      }
    }

    function toggleDamLayer(type, element) {
      if (damStates[type]) {
        map.removeLayer(damLayers[type]);
        element.style.backgroundColor = "#f8faff";
      } else {
        map.addLayer(damLayers[type]);
        element.style.backgroundColor = "#e0f7fa";
      }
      damStates[type] = !damStates[type];
    }

    function toggleDangerLayer(element) {
      if (isDangerLayerVisible) {
        map.removeLayer(dangerLayer);
        element.style.backgroundColor = "#f8faff";
      } else {
        dangerLayer.clearLayers();
        // D·ªØ li·ªáu t·ªça ƒë·ªô c√°c v√πng nguy hi·ªÉm (demo

        LIST_DANGER_AREAS.forEach(areaName => {
          const coords = dangerCoords[areaName];
          if (coords) {
            L.circle(coords, {
              color: '#ff0000',
              fillColor: '#ff0000',
              fillOpacity: 0.5,
              radius: 25000
            }).bindPopup(`<b>${areaName}</b><br>Khu v·ª±c nguy c∆° ng·∫≠p cao`)
              .addTo(dangerLayer);
          }
        });
        map.addLayer(dangerLayer);
        element.style.backgroundColor = "#e0f7fa";
      }
      isDangerLayerVisible = !isDangerLayerVisible;
    }

    // ========== CH·ª®C NƒÇNG T√åM KI·∫æM ==========
    async function performSearch() {
      const query = document.getElementById("searchInput").value.trim();
      const results = document.getElementById("searchResults");

      if (!query) {
        results.style.display = "none";
        return;
      }

      const normalizedQuery = normalizeString(query);
      let html = "";

      // T√¨m ƒë·∫≠p th·ªßy ƒëi·ªán (Local)
      const damResults = listdap.filter(d =>
        normalizeString(d.ten).includes(normalizedQuery) ||
        normalizeString(d.song).includes(normalizedQuery)
      );

      if (damResults.length > 0) {
        html += '<div style="padding:8px 12px;"><strong>Th·ªßy ƒëi·ªán:</strong></div>';
        damResults.forEach(d => {
          html += `
            <div class="search-result-item" data-lat="${d.lat}" data-lng="${d.lng}">
              <i class="fas fa-water"></i>
              <div>
                <div class="result-title">${d.ten}</div>
                <div class="result-subtitle">${d.song}</div>
              </div>
            </div>`;
        });
      }

      // T√¨m ƒë·ªãa ƒëi·ªÉm qua OpenStreetMap (Remote)
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn&limit=5`);
        const osmResults = await response.json();

        if (osmResults.length > 0) {
          html += '<div style="padding:8px 12px;"><strong>ƒê·ªãa ƒëi·ªÉm (OpenStreetMap):</strong></div>';
          osmResults.forEach(p => {
            html += `
              <div class="search-result-item" data-lat="${p.lat}" data-lng="${p.lon}">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                  <div class="result-title">${p.display_name.split(',')[0]}</div>
                  <div class="result-subtitle" style="font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">${p.display_name}</div>
                </div>
              </div>`;
          });
        }
      } catch (e) {
        console.error("L·ªói t√¨m ki·∫øm OSM:", e);
      }

      if (!html) {
        html = '<div class="no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
      }

      results.innerHTML = html;
      results.style.display = "block";

      // Th√™m s·ª± ki·ªán click cho k·∫øt qu·∫£
      results.querySelectorAll(".search-result-item").forEach(item => {
        item.addEventListener("click", function () {
          const lat = parseFloat(this.dataset.lat);
          const lng = parseFloat(this.dataset.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], 12);
            results.style.display = "none";
          }
        });
      });
    }


    // ========== H√ÄM TI·ªÜN √çCH ==========
    function normalizeString(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/ƒë/g, "d");
    }

    function closeDamDetail() {
      document.getElementById('damDetailPanel').style.display = 'none';
    }

    function openDamDetail(damId) {
      const dap = listdap.find(d => d.id === damId);
      if (dap) {
        document.getElementById('damDetailImage').src = dap.anh;
        document.getElementById('damDetailTitle').innerText = dap.ten;
        document.getElementById('damDetailInfo').innerHTML = `
          <p><strong>S√¥ng:</strong> ${dap.song}</p>
      
        `;
        document.getElementById('damDetailPanel').style.display = 'block';
      }
    }

    // H√†m m·ªü modal ph√≥ng to ·∫£nh
    function openImageModal(src) {
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImg");
      modal.style.display = "block";
      modalImg.src = src;
    }

    // H√†m x·ª≠ l√Ω khi ƒë·ªïi ƒë·∫≠p trong popup
    function doiDap(dapId, doCao, luuLuongMua) {
      console.log("ƒê·ªïi ƒë·∫≠p:", dapId);
    }

    // H√†m ch·∫°y m√¥ ph·ªèng
    function chaySim(doCao) {
      const xaLu = document.getElementById('inpXa').value;
      alert(`ƒêang ch·∫°y m√¥ ph·ªèng v·ªõi ƒë·ªô cao ${doCao}m v√† x·∫£ l≈© ${xaLu} m¬≥/s`);
    }

    // ========== S·ª∞ KI·ªÜN ==========
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("legendToggle").addEventListener("click", toggleLegendPanel);

      document.getElementById("searchInput").addEventListener("input", function () {
        if (!this.value.trim()) {
          document.getElementById("searchResults").style.display = "none";
        }
      });

      initializeMap();
      initializeDams();
    });
  </script>
</body>

</html>